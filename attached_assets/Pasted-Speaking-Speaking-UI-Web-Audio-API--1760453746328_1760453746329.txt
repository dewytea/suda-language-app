Speaking ëª¨ë“ˆì— ì‹¤ì œ ìŒì„± ì¸ì‹ ê¸°ëŠ¥ì„ ì¶”ê°€í•´ì¤˜.

=== í˜„ì¬ ìƒíƒœ ===
- ê¸°ë³¸ Speaking UI ì™„ì„±
- ë…¹ìŒ ë²„íŠ¼ ìˆìŒ (Web Audio API)
- ë¬¸ì¥ ë°ì´í„°ë² ì´ìŠ¤ ìˆìŒ
- í•˜ì§€ë§Œ ë…¹ìŒëœ ìŒì„±ì„ ë¶„ì„í•˜ì§€ ëª»í•¨

=== ì¶”ê°€í•  ê¸°ëŠ¥ ===

1. ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (Speech-to-Text)
2. ì‚¬ìš©ìê°€ ë§í•œ ë‚´ìš©ê³¼ ì›ë³¸ ë¬¸ì¥ ë¹„êµ
3. ì •í™•ë„ ì ìˆ˜ ê³„ì‚°

=== 1. Speech-to-Text ì„¤ì • ===

1.1 í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€ (.env.local)
- Web Speech API ì‚¬ìš© (ë¸Œë¼ìš°ì € ë‚´ì¥, ë¬´ë£Œ)
- ë˜ëŠ” OpenAI Whisper API (ë” ì •í™•)

Option A: Web Speech API (ì¶”ì²œ - ë¬´ë£Œ)
- ë¸Œë¼ìš°ì € ë‚´ì¥ ê¸°ëŠ¥
- ì‹¤ì‹œê°„ ì²˜ë¦¬
- API í‚¤ ë¶ˆí•„ìš”
- Chrome, Edgeì—ì„œ ì˜ ì‘ë™

Option B: OpenAI Whisper API (ê³ ê¸‰)
NEXT_PUBLIC_OPENAI_API_KEY=your_api_key
- ë” ì •í™•í•œ ì¸ì‹
- ë‹¤êµ­ì–´ ì§€ì› ìš°ìˆ˜
- ë¹„ìš© ë°œìƒ (1ë¶„ë‹¹ $0.006)

â†’ ì¼ë‹¨ Web Speech APIë¡œ ì‹œì‘í•˜ì!

=== 2. ìŒì„± ì¸ì‹ ë¡œì§ ===

2.1 lib/speech/ í´ë” ìƒì„±
â”œâ”€â”€ speechRecognition.ts
â”œâ”€â”€ compareText.ts
â””â”€â”€ calculateScore.ts

2.2 speechRecognition.ts
export function startSpeechRecognition(
  language: string, // 'en-US', 'ko-KR', etc.
  onResult: (transcript: string) => void,
  onError: (error: string) => void
) {
  // Web Speech API ì‚¬ìš©
  const SpeechRecognition = 
    window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!SpeechRecognition) {
    onError('ìŒì„± ì¸ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
    return;
  }
  
  const recognition = new SpeechRecognition();
  recognition.lang = language;
  recognition.continuous = false; // í•œ ë²ˆë§Œ ì¸ì‹
  recognition.interimResults = false; // ìµœì¢… ê²°ê³¼ë§Œ
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    onResult(transcript);
  };
  
  recognition.onerror = (event) => {
    onError(event.error);
  };
  
  recognition.start();
  return recognition;
}

2.3 compareText.ts
export function compareText(
  original: string,
  spoken: string
): {
  accuracy: number;
  matchedWords: string[];
  missedWords: string[];
  extraWords: string[];
} {
  // ëŒ€ì†Œë¬¸ì í†µì¼, êµ¬ë‘ì  ì œê±°
  const normalizeText = (text: string) => 
    text.toLowerCase()
        .replace(/[.,!?;:]/g, '')
        .trim();
  
  const originalWords = normalizeText(original).split(' ');
  const spokenWords = normalizeText(spoken).split(' ');
  
  // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë‹¨ì–´ ì°¾ê¸°
  const matchedWords = originalWords.filter((word, index) => 
    word === spokenWords[index]
  );
  
  // ë†“ì¹œ ë‹¨ì–´ (ì›ë³¸ì—ëŠ” ìˆì§€ë§Œ ë§í•˜ì§€ ì•ŠìŒ)
  const missedWords = originalWords.filter(word => 
    !spokenWords.includes(word)
  );
  
  // ì¶”ê°€ ë‹¨ì–´ (ë§í–ˆì§€ë§Œ ì›ë³¸ì— ì—†ìŒ)
  const extraWords = spokenWords.filter(word => 
    !originalWords.includes(word)
  );
  
  // ì •í™•ë„ ê³„ì‚° (0-100)
  const accuracy = Math.round(
    (matchedWords.length / originalWords.length) * 100
  );
  
  return { accuracy, matchedWords, missedWords, extraWords };
}

2.4 calculateScore.ts
export function calculateScore(
  accuracy: number,
  originalLength: number,
  spokenLength: number
): number {
  // ê¸°ë³¸ ì ìˆ˜: ì •í™•ë„
  let score = accuracy;
  
  // ê¸¸ì´ í˜ë„í‹° (ë„ˆë¬´ ì§§ê±°ë‚˜ ê¸¸ë©´ ê°ì )
  const lengthRatio = spokenLength / originalLength;
  if (lengthRatio < 0.8 || lengthRatio > 1.2) {
    score -= 10;
  }
  
  // ìµœì†Œ 0ì , ìµœëŒ€ 100ì 
  return Math.max(0, Math.min(100, score));
}

=== 3. Speaking ì»´í¬ë„ŒíŠ¸ ì—…ë°ì´íŠ¸ ===

3.1 ìƒíƒœ ì¶”ê°€
const [isRecording, setIsRecording] = useState(false);
const [transcript, setTranscript] = useState(''); // ì¸ì‹ëœ í…ìŠ¤íŠ¸
const [analysisResult, setAnalysisResult] = useState(null);

3.2 ë…¹ìŒ ë²„íŠ¼ í´ë¦­ ì‹œ
const handleRecordClick = () => {
  if (isRecording) {
    // ë…¹ìŒ ì¤‘ì§€
    recognition?.stop();
    setIsRecording(false);
  } else {
    // ë…¹ìŒ ì‹œì‘
    setIsRecording(true);
    setTranscript('');
    setAnalysisResult(null);
    
    recognition = startSpeechRecognition(
      'en-US', // í•™ìŠµ ì–¸ì–´ì— ë”°ë¼ ë³€ê²½
      (transcript) => {
        // ìŒì„± ì¸ì‹ ì™„ë£Œ
        setTranscript(transcript);
        setIsRecording(false);
        analyzeRecording(transcript);
      },
      (error) => {
        console.error('Speech recognition error:', error);
        setIsRecording(false);
        toast.error('ìŒì„± ì¸ì‹ ì‹¤íŒ¨: ' + error);
      }
    );
  }
};

3.3 ë¶„ì„ í•¨ìˆ˜
const analyzeRecording = (spokenText: string) => {
  const currentSentence = sentences[currentIndex];
  
  // í…ìŠ¤íŠ¸ ë¹„êµ
  const comparison = compareText(
    currentSentence.text,
    spokenText
  );
  
  // ì ìˆ˜ ê³„ì‚°
  const score = calculateScore(
    comparison.accuracy,
    currentSentence.text.split(' ').length,
    spokenText.split(' ').length
  );
  
  // ê²°ê³¼ ì €ì¥
  setAnalysisResult({
    score,
    transcript: spokenText,
    accuracy: comparison.accuracy,
    matchedWords: comparison.matchedWords,
    missedWords: comparison.missedWords,
    extraWords: comparison.extraWords
  });
  
  // XP ì¶”ê°€
  if (score >= 70) {
    addXP(20); // lib/gamification/addXP.ts ì‚¬ìš©
  }
  
  // ì§„ë„ ì €ì¥
  saveSpeakingProgress(
    currentSentence.id,
    score,
    true // completed
  );
};

=== 4. ê²°ê³¼ í‘œì‹œ UI ===

4.1 ë¶„ì„ ê²°ê³¼ ì¹´ë“œ
{analysisResult && (
  <div className="mt-6 p-6 bg-white rounded-xl shadow-lg">
    {/* ì ìˆ˜ í‘œì‹œ */}
    <div className="text-center mb-4">
      <div className="text-6xl font-bold text-blue-600">
        {analysisResult.score}
      </div>
      <div className="text-gray-600">ì </div>
    </div>
    
    {/* ì •í™•ë„ */}
    <div className="mb-4">
      <div className="flex justify-between mb-2">
        <span>ì •í™•ë„</span>
        <span>{analysisResult.accuracy}%</span>
      </div>
      <div className="w-full bg-gray-200 rounded-full h-2">
        <div 
          className="bg-blue-600 h-2 rounded-full"
          style={{ width: `${analysisResult.accuracy}%` }}
        />
      </div>
    </div>
    
    {/* ë‹¹ì‹ ì´ ë§í•œ ë‚´ìš© */}
    <div className="mb-4">
      <h4 className="font-semibold mb-2">ë‹¹ì‹ ì´ ë§í•œ ë‚´ìš©:</h4>
      <p className="text-gray-700 italic">
        "{analysisResult.transcript}"
      </p>
    </div>
    
    {/* ì›ë³¸ ë¬¸ì¥ */}
    <div className="mb-4">
      <h4 className="font-semibold mb-2">ì›ë³¸ ë¬¸ì¥:</h4>
      <p className="text-gray-700">
        "{currentSentence.text}"
      </p>
    </div>
    
    {/* ë‹¨ì–´ë³„ ë¶„ì„ */}
    {analysisResult.missedWords.length > 0 && (
      <div className="mb-4">
        <h4 className="font-semibold mb-2 text-orange-600">
          ë†“ì¹œ ë‹¨ì–´:
        </h4>
        <div className="flex flex-wrap gap-2">
          {analysisResult.missedWords.map((word, i) => (
            <span 
              key={i}
              className="px-3 py-1 bg-orange-100 text-orange-800 rounded-full"
            >
              {word}
            </span>
          ))}
        </div>
      </div>
    )}
    
    {analysisResult.extraWords.length > 0 && (
      <div className="mb-4">
        <h4 className="font-semibold mb-2 text-red-600">
          ì¶”ê°€ëœ ë‹¨ì–´:
        </h4>
        <div className="flex flex-wrap gap-2">
          {analysisResult.extraWords.map((word, i) => (
            <span 
              key={i}
              className="px-3 py-1 bg-red-100 text-red-800 rounded-full"
            >
              {word}
            </span>
          ))}
        </div>
      </div>
    )}
    
    {/* ì•¡ì…˜ ë²„íŠ¼ */}
    <div className="flex gap-3 mt-6">
      <button 
        onClick={handleRetry}
        className="flex-1 py-3 bg-orange-500 text-white rounded-lg"
      >
        ë‹¤ì‹œ ì—°ìŠµí•˜ê¸°
      </button>
      <button 
        onClick={handleNext}
        className="flex-1 py-3 bg-blue-600 text-white rounded-lg"
      >
        ë‹¤ìŒ ë¬¸ì¥
      </button>
    </div>
  </div>
)}

=== 5. ì–¸ì–´ ì§€ì› ===

5.1 ì–¸ì–´ ì½”ë“œ ë§¤í•‘
const LANGUAGE_CODES = {
  'english': 'en-US',
  'korean': 'ko-KR',
  'spanish': 'es-ES',
  'japanese': 'ja-JP',
  'chinese': 'zh-CN',
  'french': 'fr-FR',
  'german': 'de-DE',
  'arabic': 'ar-SA',
  'hindi': 'hi-IN',
  'portuguese': 'pt-BR'
};

5.2 ì‚¬ìš©ì í•™ìŠµ ì–¸ì–´ì— ë”°ë¼ ìë™ ì„¤ì •
const userLanguage = user.learning_languages[0]; // ì²« ë²ˆì§¸ í•™ìŠµ ì–¸ì–´
const languageCode = LANGUAGE_CODES[userLanguage] || 'en-US';

=== 6. ì—ëŸ¬ ì²˜ë¦¬ ===

6.1 ë§ˆì´í¬ ê¶Œí•œ
- ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
- ê±°ë¶€ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€
- "ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”"

6.2 ë¸Œë¼ìš°ì € ì§€ì›
- Web Speech API ë¯¸ì§€ì› ë¸Œë¼ìš°ì € ê°ì§€
- ëŒ€ì²´ ì•ˆë‚´ ë©”ì‹œì§€
- "Chromeì´ë‚˜ Edge ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”"

6.3 ì¸ì‹ ì‹¤íŒ¨
- ì•„ë¬´ ë§ë„ ì¸ì‹ ëª»í–ˆì„ ë•Œ
- "ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”" ë²„íŠ¼
- íŒíŠ¸: "ë” í¬ê³  ëª…í™•í•˜ê²Œ ë§í•´ë³´ì„¸ìš”"

=== 7. UX ê°œì„  ===

7.1 ë…¹ìŒ ì¤‘ í‘œì‹œ
- ë¹¨ê°„ ì  ê¹œë¹¡ì„
- "ë“£ê³  ìˆì–´ìš”..." í…ìŠ¤íŠ¸
- íŒŒí˜• ì• ë‹ˆë©”ì´ì…˜

7.2 ì„±ê³µ/ì‹¤íŒ¨ í”¼ë“œë°±
- ì ìˆ˜ 90ì  ì´ìƒ: "ì™„ë²½í•´ìš”! ğŸ‰"
- ì ìˆ˜ 70-89ì : "ì˜í–ˆì–´ìš”! ğŸ‘"
- ì ìˆ˜ 50-69ì : "ê´œì°®ì•„ìš”! ë‹¤ì‹œ í•´ë³¼ê¹Œìš”?"
- ì ìˆ˜ 50ì  ë¯¸ë§Œ: "ë‹¤ì‹œ ì—°ìŠµí•´ë´ìš”! ğŸ’ª"

7.3 XP íšë“ ì• ë‹ˆë©”ì´ì…˜
- "+20 XP" í† ìŠ¤íŠ¸
- ìˆ«ì ì• ë‹ˆë©”ì´ì…˜

=== 8. ë°ì´í„° ì €ì¥ ===

8.1 API ì—”ë“œí¬ì¸íŠ¸ (app/api/speaking/progress/route.ts)
export async function POST(req: Request) {
  const { userId, sentenceId, score, completed } = await req.json();
  
  const { data, error } = await supabase
    .from('user_progress')
    .upsert({
      user_id: userId,
      module_type: 'speaking',
      lesson_id: sentenceId,
      score: score,
      completed: completed,
      completed_at: new Date().toISOString()
    });
  
  if (error) {
    return Response.json({ error: error.message }, { status: 500 });
  }
  
  return Response.json({ success: true, data });
}

8.2 í†µê³„ ì—…ë°ì´íŠ¸
- user_stats í…Œì´ë¸” ì—…ë°ì´íŠ¸
- ì˜¤ëŠ˜ ë‚ ì§œì˜ ë ˆì½”ë“œì—:
  - xp_earned += 20
  - time_spent += ì‹¤ì œ ì†Œìš” ì‹œê°„
  - lessons_completed += 1

=== ì¶œë ¥ ìš”êµ¬ì‚¬í•­ ===
1. ë…¹ìŒ ë²„íŠ¼ í´ë¦­ â†’ ìŒì„± ì¸ì‹ ì‹œì‘
2. ë§í•˜ê¸° ì™„ë£Œ â†’ ìë™ìœ¼ë¡œ ë¶„ì„
3. ì ìˆ˜ í‘œì‹œ (0-100)
4. ë‹¨ì–´ë³„ ë¹„êµ ê²°ê³¼ í‘œì‹œ
5. ë†“ì¹œ ë‹¨ì–´ í•˜ì´ë¼ì´íŠ¸
6. ë‹¤ì‹œ í•˜ê¸° / ë‹¤ìŒ ë¬¸ì¥ ë²„íŠ¼
7. ì§„ë„ ìë™ ì €ì¥
8. XP ìë™ ì ë¦½
9. ì—ëŸ¬ ì²˜ë¦¬ ì™„ë²½
10. ëª¨ë°”ì¼ì—ì„œë„ ì‘ë™

=== í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ===
1. ë¬¸ì¥ í‘œì‹œ
2. ë…¹ìŒ ë²„íŠ¼ í´ë¦­
3. ë§ˆì´í¬ ê¶Œí•œ í—ˆìš©
4. ë¬¸ì¥ ì½ê¸°
5. ìë™ìœ¼ë¡œ ë¶„ì„ ì‹œì‘
6. ê²°ê³¼ í™•ì¸
7. ì ìˆ˜ ì €ì¥ í™•ì¸
8. XP ì¦ê°€ í™•ì¸

ì§€ê¸ˆ ë°”ë¡œ ì¶”ê°€í•´ì¤˜!